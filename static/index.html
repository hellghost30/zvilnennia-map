<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 85vh; }
    #sidebar {
      padding: 10px; background: #f7f7f7;
      height: 15vh; display: flex;
      flex-direction: column; justify-content: space-between;
      font-size: 14px;
    }
    #selectedInfo { margin-bottom: 5px; }
    .controls { display: flex; flex-direction: column; gap: 5px; }
    .controls input,
    .controls textarea,
    .controls button {
      width: 100%; max-width: 300px; padding: 5px; box-sizing: border-box;
    }
    #donorModal {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); display:none;
      align-items:center; justify-content:center; z-index:1000;
    }
    #donorModal .modal-content {
      background:#fff; padding:20px; border-radius:8px;
      max-height:80%; overflow-y:auto; width:300px; position:relative;
    }
    #donorModal .close-btn {
      position:absolute; top:10px; right:10px;
      background:transparent; border:none; font-size:20px; cursor:pointer;
    }
    .sector-label {
      background: rgba(255,255,255,0.8);
      padding: 4px 8px; border-radius:4px;
      text-align:center;
      white-space: normal;
      overflow-wrap:break-word;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="sidebar">
    <div id="selectedInfo">–û–±—Ä–∞–Ω–æ —Å–µ–∫—Ç–æ—Ä—ñ–≤: 0 | –°—É–º–∞: 0 –≥—Ä–Ω</div>
    <div class="controls">
      <input id="donor" placeholder="–Ü–º‚Äô—è –∞–±–æ –Ω–∞–∑–≤–∞ –±—ñ–∑–Ω–µ—Å—É" />
      <textarea id="desc" placeholder="–û–ø–∏—Å (–æ–ø—Ü—ñ–π–Ω–æ)"></textarea>
      <button onclick="submitSelection()">–ï–º—É–ª—è—Ü—ñ—è –æ–ø–ª–∞—Ç–∏</button>
      <button onclick="showDonors()">–°–ø–∏—Å–æ–∫ –¥–æ–Ω–∞—Ç–µ—Ä—ñ–≤</button>
    </div>
  </div>

  <div id="donorModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeDonors()">√ó</button>
      <h3>–°–ø–∏—Å–æ–∫ –¥–æ–Ω–∞—Ç–µ—Ä—ñ–≤</h3>
      <ul id="donorList" style="padding-left:20px; margin-top:10px;"></ul>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const map = L.map("map").setView([47,35],6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom:18, attribution:"¬© OpenStreetMap"
    }).addTo(map);

    const SECTOR_PRICE = 35, EPS = 0.0001, MIN_W = 50, MIN_H = 20;
    const selected = new Set();
    const layersById = new Map();
    const clusters = [];

    function updateSidebar() {
      const cnt = selected.size;
      document.getElementById("selectedInfo").innerText =
        `–û–±—Ä–∞–Ω–æ —Å–µ–∫—Ç–æ—Ä—ñ–≤: ${cnt} | –°—É–º–∞: ${cnt*SECTOR_PRICE} –≥—Ä–Ω`;
    }

    function showDonors() { /* ... –±–µ–∑ –∑–º—ñ–Ω ... */ }
    function closeDonors() { /* ... –±–µ–∑ –∑–º—ñ–Ω ... */ }
    function submitSelection() { /* ... –±–µ–∑ –∑–º—ñ–Ω ... */ }
    function isAdjacent(fa, fb) { /* ... –±–µ–∑ –∑–º—ñ–Ω ... */ }

    // üîí –û–ù–û–í–õ–ï–ù–û: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –∫–ª–∞—Å—Ç–µ—Ä —Ñ–æ—Ä–º—É—î –ø–æ–≤–Ω–∏–π –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫
    function isRectangularCluster(feats) {
      const cols = feats.map(f=>f.properties.grid[0]);
      const rows = feats.map(f=>f.properties.grid[1]);
      const minC = Math.min(...cols), maxC = Math.max(...cols);
      const minR = Math.min(...rows), maxR = Math.max(...rows);
      const width  = maxC - minC + 1;
      const height = maxR - minR + 1;
      return feats.length === width * height;
    }

    function clusterAndDraw(features, donor, desc){
      const pool = features.slice();
      while(pool.length){
        const cl = [ pool.pop() ];
        for(let i=0;i<cl.length;i++){
          for(let j=pool.length-1;j>=0;j--){
            if(isAdjacent(cl[i], pool[j])){
              cl.push(pool[j]); pool.splice(j,1);
            }
          }
        }
        // üîí –û–ù–û–í–õ–ï–ù–û: —Ç—ñ–ª—å–∫–∏ –ø–æ–≤–Ω—ñ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∏ –º–∞–ª—é—î–º–æ
        if (isRectangularCluster(cl)) {
          drawCluster(cl, donor, desc);
        }
      }
    }

    function drawCluster(feats, donor, desc){
      /* ... –±–µ–∑ –∑–º—ñ–Ω ... */
    }

    map.on("zoomend", ()=>{ /* ... –±–µ–∑ –∑–º—ñ–Ω ... */ });

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ–∫—Ç–æ—Ä—ñ–≤ –∑ API
    fetch("/api/sectors")
      .then(r=>r.json())
      .then(data=>{
        /* ... –±–µ–∑ –∑–º—ñ–Ω ... */
      })
      .catch(console.error);
  </script>
</body>
</html>
