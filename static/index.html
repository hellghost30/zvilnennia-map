<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Карта звільнення з draw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- Leaflet.draw CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
    integrity="sha512-HVZ2UapmZfmfoRgQnp3VZyW1zBEh4hU/9yR4gS+FpdmtvSzk0amZxwwfJNw3og1lj+V0lHBh4N7uMKIXd+ZlXg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: calc(100vh - 60px); }
    #controls {
      height: 60px;
      padding: 8px;
      background: #f7f7f7;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #controls input,
    #controls textarea {
      padding: 4px;
      font-size: 14px;
    }
    #controls button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .sector-label {
      background: rgba(255,255,255,0.8);
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
      white-space: normal;
      overflow-wrap: break-word;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

  <div id="controls">
    <input id="donor" placeholder="Ім’я або назва бізнесу" />
    <input id="desc" placeholder="Опис (опційно)" style="width:300px" />
    <button id="btnDraw">Прямокутник</button>
    <button id="btnManual">Вручну</button>
    <button id="btnDonate">Заплатити</button>
  </div>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Leaflet.draw JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"
    integrity="sha512-+CvtXj0I0Y8m07garfwJt3pX06/k1M8J+8+4hSSfdrQ7fSbbkO7xs/Fj8tqAQSOjX3mz/9X0rCYKqAl2OPRJLQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // --- Ініціалізація карти ---
    const map = L.map('map').setView([47,35], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:18, attribution:'© OpenStreetMap'
    }).addTo(map);

    const SECTOR_PRICE = 35;
    let sectorsGeoJson, manualMode = false;
    const selectedIds = new Set();
    const layersById = new Map();
    let drawControl, lastRectangle = null;

    // --- Завантажуємо сектори ---
    fetch('/api/sectors')
      .then(r=>r.json())
      .then(data=>{
        sectorsGeoJson = data;
        L.geoJSON(data, {
          style: f=>({
            color: f.properties.status==='liberated'?'#a8f0a1':'red',
            weight:1, fillOpacity:0.5
          }),
          onEachFeature: (f, layer) => {
            layersById.set(f.properties.id, layer);
            // клік у ручному режимі
            layer.on('click', () => {
              if (!manualMode || f.properties.status==='liberated') return;
              const id = f.properties.id;
              if (selectedIds.has(id)) {
                selectedIds.delete(id);
                layer.setStyle({ color:'red' });
              } else {
                selectedIds.add(id);
                layer.setStyle({ color:'#ffff99' });
              }
            });
          }
        }).addTo(map);

        // Ініціалізуємо draw-контрол
        initDrawControl();
      });

    // --- Draw control лише з rectangle ---
    function initDrawControl(){
      drawControl = new L.Control.Draw({
        draw: {
          polyline: false, polygon: false,
          circle: false, marker: false,
          circlemarker: false,
          rectangle: { shapeOptions:{ color:'blue', weight:2 } }
        },
        edit: false
      });
      map.addControl(drawControl);

      map.on('draw:created', e => {
        if (lastRectangle) map.removeLayer(lastRectangle);
        lastRectangle = e.layer.addTo(map);
      });
    }

    // --- Кнопки інтерфейсу ---
    document.getElementById('btnDraw').onclick = () => {
      manualMode = false;
      // активуємо інструмент rectangle
      drawControl._toolbars.draw._modes.rectangle.handler.enable();
    };
    document.getElementById('btnManual').onclick = () => {
      manualMode = true;
      if (lastRectangle) {
        map.removeLayer(lastRectangle);
        lastRectangle = null;
      }
      selectedIds.clear();
      // скидаємо стиль всіх незвільнених
      layersById.forEach((layer, id) => {
        if (sectorsGeoJson.features.find(f=>f.properties.id===id).properties.status!=='liberated')
          layer.setStyle({ color:'red' });
      });
    };
    document.getElementById('btnDonate').onclick = () => {
      const donor = document.getElementById('donor').value.trim();
      if (!donor) return alert('Вкажіть ім’я або бізнес');
      const desc = document.getElementById('desc').value.trim();

      let ids = [];
      if (!manualMode) {
        if (!lastRectangle) return alert('Намалюйте прямокутник');
        const bounds = lastRectangle.getBounds();
        sectorsGeoJson.features.forEach(f => {
          const center = layersById.get(f.properties.id).getBounds().getCenter();
          if (bounds.contains(center) && f.properties.status!=='liberated')
            ids.push(f.properties.id);
        });
      } else {
        ids = Array.from(selectedIds);
      }
      if (!ids.length) return alert('Не обрано жодного нового сектору');

      fetch('/api/donate', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ donor, description: desc, sectors: ids })
      })
      .then(r=>{ if(!r.ok) throw 0; return r.json(); })
      .then(()=>{
        // перефарбовуємо куплені
        ids.forEach(id => {
          const layer = layersById.get(id);
          layer.setStyle({ color:'#a8f0a1' });
        });
        alert('Дякуємо за підтримку!');
      })
      .catch(()=>alert('Помилка звільнення'));
    };
  </script>
</body>
</html>
